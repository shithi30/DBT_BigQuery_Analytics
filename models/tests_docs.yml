version: 2

sources:
  - name: workspace
    description: The Google/GCP BigQuery workspace (dataset) for flyer analytics
    dataset: dbt_smaitra
    tables:
      - name: landing_tbl
        freshness:
          warn_after: {count: 1, period: hour}
          error_after: {count: 48, period: hour}
        # loaded_at_field: report_time
        description: The main (landing) table, ETL-ed to BigQuery after scraping
        identifier: landing_grocery_flyer_items
        columns:
          - name: id
            tests:
              - unique
          - name: flyer_item
            description: The principle data point to mine other attributes from
            tests:
              - not_null
              - string_not_empty
          - name: offer_price
            tests:
              - not_negative
          - name: platform
            tests:
              - accepted_values:
                  values: ["Loblaws", "RealCanadian", "Foodland", "NoFrills", "Zehrs", "Safeway", "ThriftyFoods", "Sobeys", "Freshco", "IGA"]
              - relationships:
                  to: ref('seed_flyer_grocers')
                  field: platform
                  
models:              
  - name: serving_grocery_flyer_items
    description: The output (household) table of interest
  - name: incremental_chips_flyer_items
    description: Table to preserve historical chips entries in flyers :) 
  - name: historical_grocery_flyer_summary
    description: The statistics table, preservinging historical changes in flyers over time
  - name: seed_flyer_grocers
    description: Table to source platforms
  - name: processing_grocery_flyer_items
    description: The processed table, with refined timestamps and downstream dependencies
    tests:
      - dbt_expectations.expect_table_row_count_to_equal_other_table:
          compare_model: ref('fleeting_grocery_flyer_items')
      - dbt_expectations.expect_table_row_count_to_equal_other_table:
          compare_model: source('workspace', 'landing_tbl')