version: 2

sources:
  - name: workspace
    description: The Google/GCP BigQuery workspace (dataset) for flyer analytics
    dataset: dbt_smaitra
    tables:
      - name: landing_tbl
        description: The main (landing) table, ETL-ed to BigQuery after scraping
        identifier: landing_grocery_flyer_items
        columns:
          - name: id
            tests:
              - unique
          - name: flyer_item
            description: The principle data point to mine other attributes from
            tests:
              - not_null
              - string_not_empty
          - name: offer_price
            tests:
              - not_negative
          - name: platform
            tests:
              - accepted_values:
                  values: ["Loblaws", "RealCanadian", "Foodland", "NoFrills", "Zehrs", "Safeway", "ThriftyFoods", "Sobeys", "Freshco", "IGA"]
              - relationships:
                  to: ref('seed_flyer_grocers')
                  field: platform
    models:              
      - name: processing_tbl
        freshness:
          warn_after: {count: 1, period: hour}
          error_after: {count: 24, period: hour}
        loaded_at_field: report_time
        identifier: processing_grocery_flyer_items
      - name: serving_tbl
        description: The output (household) table of interest
        identifier: serving_grocery_flyer_items
      - name: incremental_tbl
        description: Table to preserve historical chips entries in flyers :) 
        identifier: incremental_chips_flyer_items
      - name: history_tbl
        description: The statistics table, preservinging historical changes in flyers over time
        identifier: historical_grocery_flyer_summary
      - name: seed_tbl
        description: Table to source platforms
        identifier: seed_flyer_grocers
      - name: processing_grocery_flyer_items
        description: The processed table, with refined timestamps and downstream dependencies
        tests:
          - dbt_expectations.expect_table_row_count_to_equal_other_table:
              compare_model: ref('fleeting_grocery_flyer_items')
          - dbt_expectations.expect_table_row_count_to_equal_other_table:
              compare_model: source('workspace', 'landing_tbl')